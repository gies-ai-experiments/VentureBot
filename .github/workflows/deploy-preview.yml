name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    name: Deploy Preview for PR #${{ github.event.pull_request.number }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH directory
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh

      - name: Remove stale host key
        run: |
          ssh-keygen -R "${{ secrets.VM_HOST }}" || true

      - name: Add fresh host key
        run: |
          ssh-keyscan -H "${{ secrets.VM_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy Preview to VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            set -e

            # Configuration
            PR_NUMBER=${{ github.event.pull_request.number }}
            PREVIEW_DIR="/home/ubuntu/venturebot-previews/pr-${PR_NUMBER}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            BRANCH="${{ github.head_ref }}"

            # Port mapping: PR number determines ports
            FRONTEND_PORT=$((3000 + PR_NUMBER))
            BACKEND_PORT=$((8000 + PR_NUMBER))
            PROJECT_NAME="venturebot-pr-${PR_NUMBER}"

            echo "=== PR Preview Deployment ==="
            echo "PR: #${PR_NUMBER}"
            echo "Branch: ${BRANCH}"
            echo "Frontend Port: ${FRONTEND_PORT}"
            echo "Backend Port: ${BACKEND_PORT}"

            # Ensure Docker is available
            if ! docker compose version &> /dev/null; then
                echo "Error: Docker Compose not available"
                exit 1
            fi

            # Setup preview directory
            mkdir -p "$PREVIEW_DIR"
            cd "$PREVIEW_DIR"

            # Clone or update repository
            if [ ! -d ".git" ]; then
              echo "Cloning repository..."
              git clone "$REPO_URL" .
            else
              echo "Updating repository..."
              git fetch origin --prune
            fi

            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # Create .env file
            echo "${{ secrets.ENV }}" > .env

            # Create preview-specific nginx config
            cat > frontend/nginx.preview.conf << 'NGINX_EOF'
            server {
                listen 80;
                server_name localhost;
                root /usr/share/nginx/html;
                index index.html;

                gzip on;
                gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

                location / {
                    try_files $uri $uri/ /index.html;
                }

                location /api/ {
                    proxy_pass http://backend:8000/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 86400;
                }

                location /api/chat/ws/ {
                    proxy_pass http://backend:8000/api/chat/ws/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_read_timeout 86400;
                }

                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            NGINX_EOF

            # Create standalone preview docker-compose (not an override - avoids port conflicts)
            cat > docker-compose.preview.yml << COMPOSE_EOF
            services:
              backend:
                build:
                  context: .
                  dockerfile: Dockerfile
                container_name: ${PROJECT_NAME}-backend
                ports:
                  - "${BACKEND_PORT}:8000"
                environment:
                  - PYTHONPATH=/app
                  - LOG_LEVEL=INFO
                env_file:
                  - .env
                volumes:
                  - ./data-pr-${PR_NUMBER}:/app/data
                healthcheck:
                  test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthz')"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 10s
                restart: unless-stopped

              frontend:
                build:
                  context: ./frontend
                  dockerfile: Dockerfile
                container_name: ${PROJECT_NAME}-frontend
                ports:
                  - "${FRONTEND_PORT}:80"
                volumes:
                  - ./frontend/nginx.preview.conf:/etc/nginx/conf.d/default.conf:ro
                depends_on:
                  backend:
                    condition: service_healthy
                restart: unless-stopped
            COMPOSE_EOF

            # Stop existing preview if running
            echo "--- Stopping existing preview ---"
            docker compose -p "$PROJECT_NAME" -f docker-compose.preview.yml down || true

            # Build and start preview
            echo "--- Building and starting preview ---"
            docker compose -p "$PROJECT_NAME" -f docker-compose.preview.yml up --build -d

            # Wait for services
            echo "--- Waiting for services ---"
            sleep 20

            # Health checks
            echo "--- Health Checks ---"
            if curl -f -s http://localhost:${BACKEND_PORT}/healthz > /dev/null 2>&1; then
                echo "âœ… Backend is healthy"
            else
                echo "âš ï¸ Backend may still be starting"
            fi

            if curl -f -s http://localhost:${FRONTEND_PORT} > /dev/null 2>&1; then
                echo "âœ… Frontend is healthy"
            else
                echo "âš ï¸ Frontend may still be starting"
            fi

            docker compose -p "$PROJECT_NAME" -f docker-compose.preview.yml ps

            echo ""
            echo "=== Preview Deployed ==="
            PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "VM_IP")
            echo "ðŸŒ Preview URL: http://${PUBLIC_IP}:${FRONTEND_PORT}"
            echo "ðŸ”§ API: http://${PUBLIC_IP}:${BACKEND_PORT}"

      - name: Comment Preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const frontendPort = 3000 + prNumber;
            const backendPort = 8000 + prNumber;
            const vmHost = '${{ secrets.VM_HOST }}';

            const body = `## ðŸš€ Preview Deployment Ready

            | Service | URL |
            |---------|-----|
            | **Frontend** | http://${vmHost}:${frontendPort} |
            | **API Docs** | http://${vmHost}:${backendPort}/docs |

            *Preview will be automatically removed when this PR is closed.*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployment Ready')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
